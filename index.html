<html>

<head>
  <link href="https://fonts.googleapis.com/css?family=Creepster|Crimson+Text" rel="stylesheet">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <title> Eldrtich Horror Combat Encounter Simulator </title>
  <style>
    .title {
      font-family: "Crimson Text";
      text-align: center;
    }

    .entry {
      text-align: center;
    }

    .spinner {
      text-align: left;
      display: inline-block;
    }

    .mSpinner {
      text-align: left;
      display: inline-block;
      width: 20px;
    }

    .foot {
      text-align: center;
      font-size: 10;
    }

    .btn-outline {
      background-color: transparent;
      color: inherit;
      transition: all .5s;
    }

    .btn-primary.btn-outline {
      color: #428bca;
    }

    .btn-success.btn-outline {
      color: #5cb85c;
    }

    .btn-info.btn-outline {
      color: #5bc0de;
    }

    .btn-warning.btn-outline {
      color: #f0ad4e;
    }

    .btn-danger.btn-outline {
      color: #d9534f;
    }

    .btn-dark.btn-outline {
      color: #343a40;
    }

    .btn-primary.btn-outline:hover,
    .btn-success.btn-outline:hover,
    .btn-info.btn-outline:hover,
    .btn-warning.btn-outline:hover,
    .btn-danger.btn-outline:hover,
    .btn-dark.btn-outline:hover,
      {
      color: #fff;
    }

    .player-stats-col .row {
      display: flex;
      justify-content: center;
      text-align: center;
      marign-left: auto;
      margin-right: auto;
    }

    .player-labels {
      text-align: left;
      display: inline-block;
    }
  </style>
  <script>

    function addMonster() {
        $('.monster-container').append('<div class="row">'+
            '<div class="col-sm-3">'+
              '<p class="mSpinner">'+
                '<label for="mHealthSpinner"> Health:</label>'+
                '<input id="mHealthSpinner" name="value">'+
              '</p>'+
            '</div>'+
            '<div class="col-sm-3">'+
              '<p class="mSpinner">'+
                '<label for="damageSpinner"> Damage:</label>'+
                '<input id="damageSpinner" name="value">'+
              '</p>'+
            '</div>'+
            '<div class="col-sm-3">'+
              '<p class="mSpinner">'+
                '<label for="fearSpinner"> Fear:</label>'+
                '<input id="fearSpinner" name="value">'+
              '</p>'+
            '</div>'+
          '</div>');
      }

    function getPlayer() {
      var health = document.getElementById("pHealthSpinner").value;
      var sanity = document.getElementById("sanitySpinner").value;
      var strength = document.getElementById("strengthSpinner").value;
      var will = document.getElementById("willSpinner").value;
      var rerolls = document.getElementById("rerollSpinner").value;
      var status = $("input[name=state]:checked").val();

      return new Player(health, sanity, strength, will, rerolls, status);
    }

    function getMonster() {
      var health = document.getElementById("mHealthSpinner").value;
      var damage = document.getElementById("damageSpinner").value;
      var fear = document.getElementById("fearSpinner").value;

      return new Monster(health, damage, fear);
    }

    function objectInput() {

      player = getPlayer();
      monster = getMonster();

      result = willTest(player, monster);

      var results = new Array();

      for (var i = 0; i < 100; i++) {
        player = getPlayer();
        monster = getMonster();
        results.push(willTest(player, monster));
      }

      analyzeResults(results);
    }

    function analyzeResults(results) {
      analysis = new Result(0, 0, 0, false, false);
      var monsterKillPercent = 0;
      var playerDeathPercent = 0;
      for (var i = 0; i < 100; i++) {
        analysis.sanityLost += results[i].sanityLost;
        analysis.healthLost += results[i].healthLost;
        analysis.damageDealt += results[i].damageDealt;
        if (results[i].playerDeath) {
          playerDeathPercent++;
        }
        if (results[i].monsterDeath) {
          monsterKillPercent++;
        }
      }
      analysis.sanityLost /= results.length;
      analysis.healthLost /= results.length;
      analysis.damageDealt /= results.length;

      displayResults(analysis, playerDeathPercent, monsterKillPercent);
    }

    function displayResults(analysis, playerDeathPercent, monsterKillPercent) {
      document.getElementById("avgHL").innerHTML = "Average health loss: " + analysis.healthLost;
      document.getElementById("avgSL").innerHTML = "Average sanity loss: " + analysis.sanityLost;
      document.getElementById("avgDD").innerHTML = "Average damage dealt: " + analysis.damageDealt;
      document.getElementById("pD").innerHTML = "Average player death: " + playerDeathPercent + "%";
      document.getElementById("mD").innerHTML = "Average monster death: " + monsterKillPercent + "%";

      if(playerDeathPercent > 60) {
        console.log('Here');
        document.getElementById("results").classList.remove('panel-success');
        document.getElementById("results").classList.add('panel-danger');
      } else {
        document.getElementById("results").classList.remove('panel-danger');
        document.getElementById("results").classList.add('panel-success');
    }
    }

    function Player(health, sanity, strength, will, rerolls, state) {
      this.health = Number(health);
      this.sanity = Number(sanity);
      this.strength = Number(strength);
      this.will = Number(will);
      this.rerolls = Number(rerolls);
      this.state = Number(state);
    }

    Player.prototype.toString = function playerToString() {
      return this.health + ", " + this.sanity + ", " + this.strength + ", " + this.will + ", " + this.state;
    }

    function Monster(health, damage, fear) {
      this.health = health;
      this.damage = damage;
      this.fear = fear;
    }

    Monster.prototype.toString = function monsterToString() {
      return this.health + ", " + this.damage + ", " + this.fear;
    }

    function Result(sanityLost, healthLost, damageDealt, playerDeath, monsterDeath) {
      this.sanityLost = sanityLost;
      this.healthLost = healthLost;
      this.damageDealt = damageDealt;
      this.playerDeath = playerDeath;
      this.monsterDeath = monsterDeath;
    }

    Result.prototype.toString = function resultToString() {
      return this.sanityLost + ", " + this.healthLost + ", " + this.damageDealt + ", " + this.playerDeath + ", " + this.monsterDeath;
    }

    function diceRoll(statusEffect) {
      return (Math.floor(Math.random() * 6) + 1 > 4 + statusEffect);
    }

    function checkDead(type, creature) {
      if (type === "monster") {
        return creature.health < 1;
      } else if (type === "player") {
        return (creature.health < 1 || creature.sanity < 1);
      }
    }

    function willTest(player, monster) {
      var successes = 0;
      var sanityLost = 0;
      for (var i = 0; i < player.will; i++) {
        if (diceRoll(player.state)) {
          successes++;
        }
      }
      if (successes < monster.fear) {
        sanityLost = successes - monster.fear;
        player.sanity += sanityLost;
      }
      if (checkDead("player", player)) {
        return new Result(sanityLost, 0, 0, true, false);
      } else {
        return strengthTest(player, monster, sanityLost);
      }
    }

    function strengthTest(player, monster, sanityLost) {
      var successes = 0;
      var healthLost = 0;
      for (var i = 0; i < player.strength; i++) {
        if (diceRoll(player.state)) {
          successes++;
        }
      }
      if (successes < monster.damage) {
        healthLost = successes - monster.damage;
        player.health += healthLost;
      }
      monster.health -= successes;
      return new Result(sanityLost, healthLost, successes, checkDead("player", player), checkDead("monster", monster));
    }

  </script>
</head>


<body>
  <div class="jumbotron text-center">
    <h1> Eldritch Horror Combat Sim </h1>
    <p> By: Mike Moschetti </p>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-sm-6 player-stats-col">
        <h2 class="title"> Player Stats </h2>
        <div class="row">
          <div class="col-sm-6" style="text-align: center;">
            <div style="display: inline-block; text-align: left;"> Health: </div>
          </div>
          <div class="col-sm-6 player-labels">
              <input id="pHealthSpinner" type='number' max='10' min='0' value='4' name="value">
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6" style="text-align: center;">
                <div style="display: inline-block; text-align: left;"> Sanity: </div>
            </div>
            <div class="col-sm-6 player-labels">
                <input id="sanitySpinner" type='number' max='10' min='0' value='4' name="value">
              </div>
        </div>
        <div class="row">
              <div class="col-sm-6" style="text-align: center;">
                  <div style="display: inline-block; text-align: left;"> Strength: </div>
              </div>
              <div class="col-sm-6 player-labels">
                  <input id="strengthSpinner" type='number' max='10' min='0' value='4' name="value">
                </div>
        </div>
        <div class="row">
                <div class="col-sm-6" style="text-align: center;">
                    <div style="display: inline-block; text-align: left;"> Will: </div>
                </div>
                <div class="col-sm-6 player-labels">
                    <input id="willSpinner" type='number' max='10' min='0' value='4' name="value">
                  </div>
        </div>
        <div class="row">
                  <div class="col-sm-6" style="text-align: center;">
                      <div style="display: inline-block; text-align: left;"> Rerolls: </div>
                  </div>
                  <div class="col-sm-6 player-labels">
                      <input id="rerollSpinner" type='number' max='10' min='0' value='0' name="value">
                    </div>
        </div>
        <div class="row">
          <div class="col-sm-3">
              <input type="radio" name="state" value="-1"> Blessed </input>
          </div>
          <div class="col-sm-3">
              <input type="radio" name="state" value="0" checked="checked"> None </input>
          </div>
          <div class="col-sm-3">
              <input type="radio" name="state" value="1"> Cursed </input>
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <h2 class="title"> Monster Stats </h2>
        <div class="monster-container">
          <div class="row">
            <div class="col-sm-3">
                <label for="mHealthSpinner"> Health:</label>
              <input id="mHealthSpinner" type='number' max='10' min='0' value='4' name="value">
            </div>
            <div class="col-sm-3">
                <label for="damageSpinner"> Damage:</label>
              <input id="damageSpinner" type='number' max='10' min='0' value='4' name="value">
            </div>
            <div class="col-sm-3">
                <label for="fearSpinner"> Fear:</label>
              <input id="fearSpinner" type='number' max='10' min='0' value='4' name="value">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-6">
            <button type="button" class="btn btn-danger btn-outline">Remove</button>
          </div>
          <div class="col-sm-6">
            <button id='add-monster' type="button" class="btn btn-success btn-outline" onclick="addMonster()">Add</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <button type="button" class="btn btn-primary btn-outline center-block" onclick="objectInput();"> Fight! </button>
    </div>
    <div class="container">
      <!--Can toggle between panel-success or panel-failure depending on results-->
      <div id="results" class="panel panel-success">
        <div class="panel-heading"> <h3> Results </h3> </div>
        <div id="avgHL" class="panel-body"> Avg health loss </div>
        <div id="avgSL" class="panel-body"> Avg sanity loss </div>
        <div id="avgDD" class="panel-body"> Avg damage dealt </div>
        <div id="pD" class="panel-body"> Player death % </div>
        <div id="mD" class="panel-body"> Monster death % </div>
      </div>
    </div>
    <div class="container">
      <p class="foot"> Note: This page has no affiliation to the designers/publishers. </p>
    </div>
</body>

</html>